# Generated by Jules
# Use a Node.js image
FROM node:22-alpine AS builder

WORKDIR /app

# Enable pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

# Copy root configuration files for workspace
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml tsconfig.json ./

# Copy the mcp package source code
COPY packages/mcp ./packages/mcp

# Install dependencies
RUN pnpm install --frozen-lockfile

# Build the mcp package
RUN pnpm --filter @upstash/context7-mcp build

# Production stage
FROM node:22-alpine AS runner

WORKDIR /app

# Enable pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

ENV NODE_ENV=production

# Copy root configuration files for workspace (needed for pnpm install --prod)
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY packages/mcp/package.json ./packages/mcp/package.json

# Copy built artifacts from builder
COPY --from=builder /app/packages/mcp/dist ./packages/mcp/dist

# Install production dependencies only
# We use pnpm to respect lockfile
RUN pnpm install --prod --frozen-lockfile --filter @upstash/context7-mcp

# Expose port 3000
EXPOSE 3000

# Start the server
# We run node directly on the built file
CMD ["node", "packages/mcp/dist/index.js", "--transport", "http"]
